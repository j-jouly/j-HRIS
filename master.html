// Supabase Configuration
const _supabaseUrl = 'https://bzrycuvpbsxvutqhxowp.supabase.co';
const _supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6cnljdXZwYnN4dnV0cWh4b3dwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNTk5OTEsImV4cCI6MjA4NjkzNTk5MX0.MI2suZLflcMbc5AbPCRaT7_pT9qQISrsV5dKA63Si8s';
const supabaseClient = supabase.createClient(_supabaseUrl, _supabaseKey);

const btnNav = ['btnNew', 'btnModify', 'btnDelete', 'btnSearch'];
const btnAct = ['btnSave', 'btnCancel', 'btnAddDetail', 'btnRemoveDetail'];
const formInputs = ['empl_unme', 'empl_pswd', 'empl_name', 'empl_addr', 'empl_stat', 'empl_levl'];

// Variabel untuk melacak apakah sedang mode Tambah atau Edit
let currentMode = 'VIEW'; 

function setMode(mode) {
    currentMode = mode.toUpperCase();
    const isEdit = currentMode === 'EDIT' || currentMode === 'NEW';
    
    // Toggle Buttons
    btnNav.forEach(id => document.getElementById(id).disabled = isEdit);
    btnAct.forEach(id => document.getElementById(id).disabled = !isEdit);
    
    // Toggle Inputs
    formInputs.forEach(id => document.getElementById(id).disabled = !isEdit);

    if (currentMode === 'VIEW') {
        // Jangan reset form di sini jika ingin data tetap tampil setelah klik tabel
        // Reset hanya dilakukan saat batal atau setelah simpan sukses
    }
}

async function fetchData() {
    const tableBody = document.getElementById('employeeTableBody');
    const s_kode = document.getElementById('search_kode').value;
    const s_nama = document.getElementById('search_nama').value;
    const s_stat = document.getElementById('search_status').value;

    tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">üîç Mencari data...</td></tr>';

    try {
        let query = supabaseClient.from('TH_EMP01M').select('EMPL_NMBR, EMPL_NAME, EMPL_STAT, EMPL_LEVL');

        if (s_kode) query = query.ilike('EMPL_NMBR', `%${s_kode}%`);
        if (s_nama) query = query.ilike('EMPL_NAME', `%${s_nama}%`);
        if (s_stat !== "") query = query.eq('EMPL_STAT', s_stat === "1");

        const { data, error } = await query.order('EMPL_NMBR', { ascending: true });
        if (error) throw error;

        tableBody.innerHTML = '';
        if (data.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Data tidak ditemukan.</td></tr>';
            return;
        }

        data.forEach(emp => {
            const statusDot = emp.EMPL_STAT ? '<span style="color:#10b981;">‚óè Active</span>' : '<span style="color:#ef4444;">‚óè In Active</span>';
            const levelTag = emp.EMPL_LEVL ? '<small style="background:#e0f2fe; color:#0369a1; padding:2px 8px; border-radius:10px;">Admin</small>' : '<small style="background:#f1f5f9; color:#475569; padding:2px 8px; border-radius:10px;">User</small>';
            
            tableBody.innerHTML += `
                <tr onclick="getDetail('${emp.EMPL_NMBR}')">
                    <td style="font-weight:600; color:#3b82f6;">${emp.EMPL_NMBR}</td>
                    <td>${emp.EMPL_NAME}</td>
                    <td>${statusDot}</td>
                    <td>${levelTag}</td>
                </tr>`;
        });
    } catch (err) {
        tableBody.innerHTML = `<tr><td colspan="4" style="color:red; text-align:center;">Error: ${err.message}</td></tr>`;
    }
}

async function getDetail(id) {
    try {
        const { data, error } = await supabaseClient.from('TH_EMP01M').select('*').eq('EMPL_NMBR', id).single();
        if (error) throw error;

        // Isi Form
        document.getElementById('empl_nmbr').value = data.EMPL_NMBR || "";
        document.getElementById('empl_name').value = data.EMPL_NAME || "";
        document.getElementById('empl_unme').value = data.EMPL_UNME || "";
        document.getElementById('empl_pswd').value = data.EMPL_PSWD || "";
        document.getElementById('empl_addr').value = data.EMPL_ADDR || "";
        document.getElementById('empl_stat').value = data.EMPL_STAT ? "1" : "0";
        document.getElementById('empl_levl').value = data.EMPL_LEVL ? "1" : "0";

        // Set ke mode VIEW (input terkunci)
        setMode('VIEW');
        
        // Aktifkan tombol Modify & Delete
        document.getElementById('btnModify').disabled = false;
        document.getElementById('btnDelete').disabled = false;
        // Ganti onclick alert menjadi fungsi modify
        document.getElementById('btnModify').onclick = () => setMode('EDIT');

    } catch (err) {
        alert("Gagal ambil detail: " + err.message);
    }
}

async function startNew() {
    document.getElementById('employeeForm').reset();
    setMode('NEW');
    try {
        const { count, error } = await supabaseClient.from('TH_EMP01M').select('*', { count: 'exact', head: true });
        if (error) throw error;
        const nextNo = (count || 0) + 1;
        document.getElementById('empl_nmbr').value = `GPro.${String(nextNo).padStart(3, '0')}`;
    } catch (err) {
        alert("Gagal generate nomor: " + err.message);
    }
}

async function saveData() {
    const data = {
        EMPL_NMBR: document.getElementById('empl_nmbr').value,
        EMPL_NAME: document.getElementById('empl_name').value,
        EMPL_UNME: document.getElementById('empl_unme').value,
        EMPL_PSWD: document.getElementById('empl_pswd').value,
        EMPL_ADDR: document.getElementById('empl_addr').value,
        EMPL_STAT: document.getElementById('empl_stat').value === "1",
        EMPL_LEVL: document.getElementById('empl_levl').value === "1"
    };

    if (!data.EMPL_NAME || !data.EMPL_UNME || !data.EMPL_PSWD) {
        return alert("Mohon lengkapi Nama, Username, dan Password!");
    }

    try {
        let result;
        if (currentMode === 'NEW') {
            result = await supabaseClient.from('TH_EMP01M').insert([data]);
        } else {
            // Mode EDIT: Update berdasarkan EMPL_NMBR
            result = await supabaseClient.from('TH_EMP01M').update(data).eq('EMPL_NMBR', data.EMPL_NMBR);
        }

        if (result.error) throw result.error;
        
        alert("Data Berhasil Disimpan!");
        setMode('VIEW');
        fetchData();
    } catch (err) {
        alert("Gagal Simpan: " + err.message);
    }
}

// Tambahkan fungsi delete untuk melengkapi
document.getElementById('btnDelete').onclick = async () => {
    const id = document.getElementById('empl_nmbr').value;
    if (!id || !confirm(`Hapus karyawan ${id}?`)) return;

    try {
        const { error } = await supabaseClient.from('TH_EMP01M').delete().eq('EMPL_NMBR', id);
        if (error) throw error;
        alert("Data Terhapus");
        document.getElementById('employeeForm').reset();
        fetchData();
        setMode('VIEW');
    } catch (err) {
        alert(err.message);
    }
};

window.onload = () => {
    if (!localStorage.getItem('userSession')) {
        window.location.href = 'index.html';
    } else {
        fetchData();
    }
};
